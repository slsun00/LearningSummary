## 语句结构  -- 动态 sql

```jaa
MyBatis3 采用功能强大的基于 OGNL 的表达式来消除其他元素
就是在 sql 中使用
	数据结构  + 语句结构
```

##  == 流程控制 == 

## 选择分支语句

### if 分支控制

#### 单重判断

```sql
使用
	动态 SQL 通常要做的事情是有条件地包含 where 子句的一部分
介绍
	如果 if 标签中的 
		test 属性字段为真，
			if 标签包括的语句就会追加 if 所在位置
		test 属性字段为假，
			if 标签包括的语句就会被省略
			

<select id="findActiveBlogWithTitleLike"
     resultType="Blog">
  SELECT * FROM BLOG 
  WHERE state = ‘ACTIVE’ 
/*
如果传入了 title 
	语句变为：  WHERE state = ‘ACTIVE’  AND title like #{title}
如果没有传入 title
	语句变成：   WHERE state = ‘ACTIVE’
*/  
  <if test="title != null">
    AND title like #{title}
  </if>
</select>
```

#### 多重判断

```java
<select id="findActiveBlogLike"
     resultType="Blog">
  SELECT * FROM BLOG WHERE state = ‘ACTIVE’ 
  <if test="title != null">
    AND title like #{title}
  </if>
  <if test="author != null and author.name != null">
    AND author_name like #{author.name}
  </if>
</select>
```

#### if 优化 -where

##### if 分支问题

```sql
问题
	1. 当一个条件也没有匹配上
		SELECT * FROM BLOG WHERE
     2. 仅仅当中间的条件成立
     	SELECT * FROM BLOG
        WHERE
        AND title like 'someTitle'
     3. 以上两种情况，都会导致查询失败
     //============================
    <select id="findActiveBlogLike"
         resultType="Blog">
      SELECT * FROM BLOG 
      WHERE 
      <if test="state != null">
        state = #{state}
      </if> 
      <if test="title != null">
        AND title like #{title}
      </if>
      <if test="author != null and author.name != null">
        AND author_name like #{author.name}
      </if>
    </select>	
```

##### 优化 - where

```sql
介绍
	where 元素知道只有在一个以上的if条件有值的情况下才去插入"WHERE"子句。
	而且，若最后的内容是"AND"或"OR"开头的，where 元素也知道如何将他们去除。
	
	
    <select id="findActiveBlogLike"
         resultType="Blog">
      SELECT * FROM BLOG 
      <where> 
        <if test="state != null">
             state = #{state}
        </if> 
        <if test="title != null">
            AND title like #{title}
        </if>
        <if test="author != null and author.name != null">
            AND author_name like #{author.name}
        </if>
      </where>
    </select>
// ===================================================    
where 优化
/*
过自定义 trim 元素来定制我们想要的功能 
 where 元素等价的自定义 trim 元素	

prefixOverrides 属性
	会忽略通过管道分隔的文本序列（注意此例中的空格也是必要的）。
	它带来的结果就是所有在 prefixOverrides 属性中指定的内容将被移除，并且插入 prefix 属性中指定的内容
*/
<trim prefix="WHERE" prefixOverrides="AND |OR ">
  ... 
</trim>
```

##### 优化 - set

```java
介绍
	用于动态更新语句的解决方案叫做 set。
    set 元素可以被用于动态包含需要更新的列，而舍去其他的。

例子
/*
	set 元素会动态前置 SET 关键字，同时也会消除无关的逗号，
	因为用了条件语句之后很可能就会在生成的赋值语句的后面留下这些逗号。
	
*/    
<update id="updateAuthorIfNecessary">
  update Author
    <set>
      <if test="username != null">username=#{username},</if>
      <if test="password != null">password=#{password},</if>
      <if test="email != null">email=#{email},</if>
      <if test="bio != null">bio=#{bio}</if>
    </set>
  where id=#{id}
</update>   
    
set 优化
    // 注意这里我们忽略的是后缀中的值，而又一次附加了前缀中的值
    <trim prefix="SET" suffixOverrides=",">
      ...
    </trim>    
```

###  choose 分支控制

```sql
<select id="findActiveBlogLike"
     resultType="Blog">
  SELECT * FROM BLOG WHERE state = ‘ACTIVE’
  
 /*
	但是这次变为提供了"title"就按"title"查找，
	提供了"author"就按"author"查找，
	若两者都没有提供，就返回所有符合条件的BLOG
	（实际情况可能是由管理员按一定策略选出BLOG列表，而不是返回大量无意义的随机结果）。
 
 */ 
  <choose>
    <when test="title != null">
      AND title like #{title}
    </when>
    <when test="author != null and author.name != null">
      AND author_name like #{author.name}
    </when>
    <otherwise>
      AND featured = 1
    </otherwise>
  </choose>
</select>
```

## == 数据结构 ==

## 集合

### 遍历 - foreach

```sql
介绍
	1. 允许你指定一个集合，声明可以用在元素体内的集合项和索引变量
	2. 允许你指定开闭匹配的字符串以及在迭代中间放置分隔符
	3. 这个元素是很智能的，因此它不会偶然地附加多余的分隔符
注意
	可以将一个 List 实例或者数组作为参数对象传给 MyBatis，
	MyBatis 会自动将它包装在一个 Map 中并以名称为键
		list 实例将会以"list"作为键，
		数组实例的键将是"array"

<select id="selectPostIn" resultType="domain.blog.Post">
  SELECT *
  FROM POST P
  WHERE ID in
  <foreach item="item" index="index" collection="list"
      open="(" separator="," close=")">
        #{item}
  </foreach>
</select>
```



