## 基于 jwt 的 token 登陆

```java
前端
    1. 用户填写登陆表单，登陆表单的数据传给前端框架(vue 的 data, react 的 state)
    2. 前端通过 axios 的 data 进行传递
    
后端
    1. controller 进行 requestbody 解析请求携带的结构体（包含登陆信息）
    2. service 层将得到的登陆信息进行校验
    	通过手机号从数据库查询用户的详细信息，
    		密码核对
    		是否被禁用用户
    	将需要各个模块需要共享的账户信息（id,name,头像）聚合下，封装为一个 jwtToken 字符串返回
    // 注意
    /*
    	token 是存在数据库，是token这个数据结构的内部字段存储在服务器，
    	不是说组装的成品放在后端
    */
前端
    
    // 对于cookie 的保存，你可以直接在后端进行设置，感觉这样比较好
    // 
    将 response 的 token(jwtToken) 放入cookie,然后设置下父域
    
    最后将首页进行跳转
```





## 前端

### api

```java
import request from '~/utils/request'
// import cookie from 'js-cookie'

export default {
  submitLogin(user) {
    return request({
      baseURL: 'http://localhost:8160',
      url: '/api/ucenter/member/login',
      method: 'post',
      data: user
    })
  }
}
```

### 页面

```js
import cookie from 'js-cookie'
import loginApi from '~/api/login'

methods: {
    // 登录
    submitLogin() {
        // 执行登录
        loginApi.submitLogin(this.user)
            .then(response => {
            // 登录成功后将jwtToken写入cookie, cookie 是固定的包，是需要记忆的
            
            // 把 cookie 放到父域名下，他就可以所有的子模块都可以使用了
            /*
             pass.jd.com
             order.jd.com
             item.jd.com
            
            */
            cookie.set('guli_jwt_token', 
                       response.data.token, 
                       {
                		domain: 'localhost'    // 父域名
            			}
                      )
            //跳转到首页
            window.location.href = '/'
        })
    }
}
```



## 后端

### controller

```java
@ApiOperation(value = "会员登录")
@PostMapping("login")
public R login(@RequestBody LoginVo loginVo) {
    String token = memberService.login(loginVo);
    return R.ok().data("token", token);
}
```

### service

```java
@Override
public String login(LoginVo loginVo) {

    String mobile = loginVo.getMobile();
    String password = loginVo.getPassword();

    //校验参数
    if (StringUtils.isEmpty(mobile)
        || !FormUtils.isMobile(mobile)
        || StringUtils.isEmpty(password)) {
        throw new GuliException(ResultCodeEnum.PARAM_ERROR);
    }

    //校验手机号
    QueryWrapper<Member> queryWrapper = new QueryWrapper<>();
    queryWrapper.eq("mobile", mobile);
    
    Member member = baseMapper.selectOne(queryWrapper);
    if(member == null){
        throw new GuliException(ResultCodeEnum.LOGIN_MOBLE_ERROR);
    }

    //校验密码
    if(!MD5.encrypt(password).equals(member.getPassword())){
        throw new GuliException(ResultCodeEnum.LOGIN_PASSWORD_ERROR);
    }

    //检验用户是否被禁用
    if(member.getDisabled()){
        throw new GuliException(ResultCodeEnum.LOGIN_DISABLED_ERROR);
    }

    JwtInfo jwtInfo = new JwtInfo();
    jwtInfo.setId(member.getId());
    jwtInfo.setNickname(member.getNickname());
    jwtInfo.setAvatar(member.getAvatar());
    String jwtToken = JwtUtils.getJwtToken(jwtInfo, 1800);

    return jwtToken;
}
```

### entity

```java
package com.atguigu.guli.service.ucenter.entity.vo;

@Data
public class LoginVo implements Serializable {
    private static final long serialVersionUID = 1L;
    private String mobile;
    private String password;
}
```



## // ===

## == 退出 ==

## 前端

### 页面

```js
<a href="javascript:void(0);" title="退出" class="ml5" 
   @click="logout()">退出</a>

logout() {
    cookie.set(
        'guli_jwt_token', 
        '', 
        { domain: 'localhost' }
    )
    // 跳转页面
    window.location.href = '/'
}


```


